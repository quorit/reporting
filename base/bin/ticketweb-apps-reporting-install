#!/bin/bash

#default values
devel_mode=0
venv_id=unset
ticketweb_venv_root=unset


usage()
{
  echo "Usage 1: ticketweb-apps-reporting-install --devel-mode <venv_root> <git_dir>"
  echo "Usage 2: ticketweb-apps-reporting-install <venv_id> <web_root>"
  exit 2
}


PARSED_ARGUMENTS=$(getopt --name ticketweb-apps-reporting-install -o d --long devel-mode -- "$@")

VALID_ARGUMENTS=$?
if [ "$VALID_ARGUMENTS" != "0" ]; then
  usage
fi


eval set -- "$PARSED_ARGUMENTS"
while :
do
  case "$1" in
    --devel-mode)   devel_mode=1      ; shift   ;;
    # -- means the end of the arguments; drop this, and break out of the while loop
    --) shift; break ;;
    # If invalid options were passed, then getopt should have reported an error,
    # which we checked as VALID_ARGUMENTS when getopt was called...
    *) echo "Unexpected option: $1 - this should not happen."
       usage ;;
  esac
done


if (( "$devel_mode" == 1 && $# != 2 || "$devel_mode" == 0 && $# != 2 )); then
    usage
fi



if [[ "$devel_mode" -eq 0 ]]; then
   new_user_id=ticketweb_"$venv_id"_apps_reporting
   useradd --system --no-create-home $new_user_id
   mkdir --parents --mode=770 /var/log/ticketweb/"$venv_id"/applications/reporting 
   chown $new_user_id:$new_user_id /var/log/ticketweb/"$venv_id"/applications/reporting


fi


if [[ "$devel_mode" -eq 0 ]]; then
    venv_id=$1
    venv_roots_file=/etc/ticketweb_venv_roots.json
    ticketweb_venv_root=$(cat "$venv_roots_file" | jq ."$venv_id" | sed -e 's/^"//' -e 's/"$//' )
else
    ticketweb_venv_root=$1

fi


script_dir=$(dirname -- "$0")



if [[ "$devel_mode" -eq 0 ]]; then
    frontend_src_dir=$(mktemp -d)
    cd $frontend_scr_dir
    tar xzvf /usr/share/ticketweb/applications/reporting/frontend.tar.gz
fi    

#We might really want to switch to a branch matching the venv_id, like "preview" or "final".

source $ticketweb_venv_root/bin/activate

if [[ "$devel_mode" -eq 0 ]]; then
    pip install --force-reinstall "git+https://github.com/quorit/ticketweb-apps-reporting.git#subdirectory=server"

else
    git_repo_dir="$2"
    cd "$git_repo_dir"/server
    pip install --editable .
fi


shared_data_target_dir=$ticketweb_venv_root/usr/share/ticketweb/applications/reporting
shared_data_src_dir="$git_repo_dir"/shared_data


mkdir --parents $shared_data_target_dir

if [[ "$devel_mode" -eq 0 ]]; then
    cp -r "$shared_data_src_dir"/* "$shared_data_target_dir" 
else
    ln -s "$shared_data_src_dir"/* "$shared_data_target_dir"
fi

if [[ "$devel_mode" -eq 0 ]]; then
   cd "$frontend_src_dir"
   npm install
   VUE_APP_TICKETWEB_PATH=$3
   export VUE_APP_TICKETWEB_PATH
   npm run build
   frontend_dir="$ticketweb_venv_root"/srv/ticketweb/applications/reporting/frontend
   mkdir --parents "$frontend_dir"
   cp -r dist/* "$frontend_dir"
fi

if [[ "$devel_mode" -eq 1 ]]; then
    pip install --force-reinstall "git+https://github.com/danvk/RangeHTTPServer"
    #not installing from pip because the pip version is not up do date and only runs on port 8000
fi
